with open("custom_system_header_template.md", encoding="utf-8") as f:
    __BASE_REACT_CHAT_SYSTEM_HEADER = f.read()

CUSTOM_REACT_CHAT_SYSTEM_HEADER = __BASE_REACT_CHAT_SYSTEM_HEADER.replace(
    "{context_prompt}", "", 1
)

CUSTOM_CONTEXT_REACT_CHAT_SYSTEM_HEADER = __BASE_REACT_CHAT_SYSTEM_HEADER.replace(
    "{context_prompt}",
    """
Here is some context to help you answer the question and plan:
{context}
""",
    1,
)

ENTITY_RECOGNITION_TEMPLATE = """
# 任务：
根据用户输入识别关键实体和信息，并按照指定格式输出。

# 输出格式：
请严格按照以下JSON格式输出：
```json
[{{"entity_name":"实体名称","entity_type":"实体类型","context_info":"上下文信息","entity_category":"实体类别"}}]
```

# 要求：
使用代码格式进行输出，将实体列表按照用户输入内提到的顺序排序，并使用json代码块输出结果。
未找到实体时输出空list。

# 用户输入：
{input}

# 知识：
- 实体名称常见形式及对应类型示例：XXX公司（组织），XXX产品（产品），XXX服务（服务），XXX地区/XXX市（地区），XXX人员（人物），XXX系统（系统），XXX技术（技术），XXX方法（方法），XXX标准（标准），XXX项目（项目），XXX平台（平台），XXX工具（工具）；未知实体的类型为"其他"。
- 公司实体类型包括：股份有限公司、有限公司、集团公司、事业单位、政府机构、非营利组织。
- 产品实体类型包括：软件产品、硬件产品、服务产品、数字产品、物理产品。
- 地区实体类型包括：国家、省份、城市、区县、街道、社区、开发区、园区。
- 人员实体类型包括：企业家、技术人员、管理人员、研究人员、专家、学者、员工。
- 系统实体类型包括：信息系统、管理系统、操作系统、应用系统、平台系统、网络系统。
- 技术实体类型包括：信息技术、生物技术、材料技术、能源技术、航天技术、军事技术。
- 方法实体类型包括：研究方法、分析方法、设计方法、生产方法、管理方法、教学方法。
- 标准实体类型包括：国际标准、国家标准、行业标准、企业标准、技术标准、安全标准。
- 项目实体类型包括：科研项目、工程项目、信息化项目、改革项目、发展项目、创新项目。
- 平台实体类型包括平台、社交：服务平台平台、娱乐平台、教育平台、医疗平台。
- 工具实体类型包括、交易：软件工具、硬件工具、分析工具、设计工具、管理工具、生产实体名称识别规则：优先识别专工具。
- 有名词，如、产品名、地名、人名等公司名按；复合名称空格分割后分别识别；避免识别常见通用词汇。
- 实体类型分类原则：根据上下文和领域知识判断最符合的类别；多义实体根据出现频率和重要性判断；不确定时归类为"其他"。

# json示例：
输入：“某公司发布了新产品Alpha，支持OCR与全文检索” 输出：[{{"entity_name":"某公司","entity_type":"组织","context_info":"发布新产品","entity_category":"组织"}},{{"entity_name":"产品Alpha","entity_type":"产品","context_info":"支持OCR与全文检索","entity_category":"产品"}}]
输入：“请比较React与Vue的优缺点，并给出选型建议” 输出：[{{"entity_name":"React","entity_type":"技术","context_info":"对比与选型","entity_category":"技术"}},{{"entity_name":"Vue","entity_type":"技术","context_info":"对比与选型","entity_category":"技术"}}]
输入：“我们要在上海落地一个数据治理项目，目标是降本增效” 输出：[{{"entity_name":"上海","entity_type":"地区","context_info":"项目落地地点","entity_category":"地区"}},{{"entity_name":"数据治理项目","entity_type":"项目","context_info":"目标降本增效","entity_category":"项目"}}]
"""

PLANNING_JUDGE_TEMPLATE = """
你是一个擅长判断用户意图的专家，现在有一段用户针对大模型生成的研究计划的回复，请你判断用户是否认可这个研究计划。

【用户回复】
{query}

【输出要求】
1. 你可以使用思考过程分析【用户回复】中用户是否认可此研究计划。但是你的回答部分必须遵循以下规则：若你判断用户认可研究计划，回答“肯定”；否则，回答“否定”。
2. 你必须使用中文回答。

【判断结果】：
"""

with open('planning_header_template.md', 'r', encoding='utf-8') as f:
    PLANNING_TEMPLATE = f.read()

PLAN_MODIFY_TEMPLATE = """
你是一个擅长进行研究计划制定和修改的专家。现在有一份研究计划需要修改，相应的修改意见已经给出。
请你根据修改意见，对研究计划进行修改。

【研究计划】：
{current_plan}

【修改意见】：
{modify_suggestion}

【输出要求】：
1. 你可以使用思考过程分析如何对【研究计划】进行修改。但是你的回答部分必须仅包含修改完成的研究计划。
2. 修改完成的研究计划必须遵循原有的格式，即任务列表的形式。
3. 研究计划必须使用中文。
4. 你只需输出修改后的【研究计划】，无需输出其他内容。

"""

PLAN_UPDATE_TEMPLATE = """
你是一个擅长把控研究实施进度、适时进行计划修正的专家。现在你正在跟进一项研究，需要你根据当前研究进展，对现有的计划进行【更新】操作、【改动】操作
或是【更新】操作 +【改动】操作。

【更新规则】：
1. 你需要根据【动作历史和相应计划执行结果】，判断是否需要对当前研究计划的进展进行更新。大部分情况下，研究计划都会被顺利推进；少部分情况下，研究计划未被完成，此时无需更新。
2. 现有计划采用的是markdown任务列表的格式。要更新当前进展，只需在对应"[ ]"中画"x"形成"[x]"，即代表该项任务已完成。例如

- [x] (Plan Step1 here)
- [ ] (Plan Step2 here)
- [ ] (Plan Step3 here)

代表Step1已经完成，Step2和Step3未完成。
3. 执行更新操作，你只被允许通过上述画"x"操作更新任务列表的进度。任务列表本身的内容不允许在此操作中被更新。若你认为任务内容需要改动，请参照下述【改动规则】进行改动。
4. 计划成功执行但是没有获取到数据，也应该被标记为已完成

【改动规则】：
1. 你需要根据【动作历史和相应计划执行结果】，判断是否需要对后续的计划步骤进行改动修正。注意，改动不是必须的，只有在你认为现有执行结果与后续计划步骤有显著不适配时，才对后续计划步骤进行改动。
2. 你的改动修正可以是增加步骤，减少步骤，调换某两个步骤或是修改某个步骤的内容。
3. 你需要在思考过程中提供你做这项改动的理由，但不允许在回答正文部分提供。
4. 改动后的计划仍遵循原有markdown任务列表的格式。

【输出规则】：
1. 你可以使用思考过程进行【更新】和【改动】操作，且一次只能进行一种操作。但在回答正文部分**仅输出**执行所有【更新】和【改动】操作后的任务列表，**不包含改动说明等任何其他内容**。
2. 你也可以不执行任何操作，直接返回原计划。例如，若你认为当前的进展并没有推进研究进度，且研究计划无需改动，则可以直接返回原计划。

以下是当前计划：
{current_plan}

以下是当前的【动作历史和相应计划执行结果】（若为空则代表还没有进展，返回原计划即可）：
"""


NER_EXTRACT_TEMPLATE = """
你是一个专业的信息抽取专家，请从【用户问题】中识别出关键、核心的实体名称，并返回一个 Python 列表。

【用户问题】
{query}

【要求】：
1. 仅提取最关键的信息（通常是问题主语或命名中最核心的实体）。
2. 优先选择具有唯一标识性的名称。
3. 返回结果必须是 Python 列表格式，且形式为：["关键名称"]。
4. 使用与【用户问题】相同的语言（如中文）。
5. 不要解释、不要思考过程、不要额外文本，只输出列表。

【示例】
输入：某公司发布了产品Alpha并宣布在上海落地项目
输出：['某公司', '产品Alpha', '上海', '项目']
"""


FILTER_PROMPT_TEMPLATE = """
你是一个擅长文档关联性分析的专家，擅长判断提供的文档是否与用户问题相关。请你判断下述【文档片段】是否与【用户问题】相关：

【文档片段】
{doc_chunks}

【用户问题】
{query}

【要求】：
1. 【文档片段】中，每段文档以**Document**标志开头。
2. 所有【文档片段】都包含了【用户问题】中涉及的设备，但仅包含相关设备不能作为【文档片段】与【用户问题】相关的依据。你必须考虑该【文档片段】是否能够正面回答【用户问题】。
3. 你可以使用思考过程分析【文档片段】和【用户问题】的相关性。回答部分必须按如下格式输出两行：
第一行只输出“相关”或“无关”。
第二行只输出“SCORE: X”，其中 X 为 0 到 100 的整数，代表相关性得分。

【判断结果】：
"""

# 意图识别模板 - 用于识别是否需要快速响应
INTENT_RECOGNITION_TEMPLATE = """
# 任务：
你是一个意图识别专家。请分析用户输入，判断是否属于可以快速响应的标准场景，并确定需要执行的工作流程分类。

# 用户输入：
{input}

# 快速响应规则：
1. 如果用户明确只需要一句话定义/结论（如"一句话总结"、"给我结论"），返回一个简短标准答案。
2. 其他情况不触发快速响应。

# 工作流程分类识别规则：
根据用户输入的需求类型选择 workflow_categories，优先命中一条规则即可：

1. 若用户要求阅读/提取/逐段引用资料，分类为：["research-document"]
2. 若用户要求分析问题、定位原因、找漏洞/风险点，分类为：["research-problem"]
3. 若用户要求制定步骤/研究计划/路线图，分类为：["research-planning"]
4. 若用户要求做选型/权衡/给出决策建议，分类为：["research-decision"]
5. 若用户报告报错/故障/需要排查与修复建议，分类为：["technical-troubleshooting"]
6. 若用户要点子/创意/方案脑暴/设计稿，分类为：["creative-design"]
7. 其他情况，分类为：["research-general"]


# 输出格式示例：
请按照以下JSON格式输出：
```json
{{
  "is_quick_response": true/false,
  "standard_answer": "标准答案内容或空字符串",
  "workflow_categories": ["分类1", "分类2"]
}}
```

# 要求：
1. 仔细分析用户输入，匹配上述规则
2. 如果匹配任何快速响应规则，设置 is_quick_response 为 true，并提供相应的 standard_answer
3. 如果不匹配任何快速响应规则，设置 is_quick_response 为 false，standard_answer 为空字符串
"""

PLAN_UPDATE_TEMPLATE = """
你是一个擅长把控研究实施进度、适时进行计划修正的专家。现在你正在跟进一项研究，需要你根据当前研究进展，对现有的计划进行【更新】操作、【改动】操作
或是【更新】操作 +【改动】操作。


【更新规则】:
1. 你需要根据【动作历史和相应计划执行结果】，判断是否需要对当前研究计划的进展进行更新。大部分情况下，研究计划都会被顺利推进；少部分情况下，研究计划未被完成，此时无需更新。
2. 现有计划采用的是markdown任务列表的格式。要更新当前进展，只需在对应"[ ]"中画"x"形成"[x]"，即代表该项任务已完成。例如

- [x] (Plan Step1 here)
- [ ] (Plan Step2 here)
- [ ] (Plan Step3 here)

代表Step1已经完成，Step2和Step3未完成。
3. 执行更新操作，你只被允许通过上述画"x"操作更新任务列表的进度。任务列表本身的内容不允许在此操作中被更新。若你认为任务内容需要改动，请参照下述【改动规则】进行改动。
4. 计划成功执行但是没有获取到数据，也应该被标记为已完成

【改动规则】:
1. 你需要根据【动作历史和相应计划执行结果】，判断是否需要对后续的计划步骤进行改动修正。注意，改动不是必须的，只有在你认为现有执行结果与后续计划步骤有显著不适配时，才对后续计划步骤进行改动。
2. 你的改动修正可以是增加步骤，减少步骤，调换某两个步骤或是修改某个步骤的内容。
3. 你需要在思考过程中提供你做这项改动的理由，但不允许在回答正文部分提供。
4. 改动后的计划仍遵循原有markdown任务列表的格式。


【输出规则】:
1. 你可以使用思考过程进行【更新】和【改动】操作，且一次只能进行一种操作。但在回答正文部分**仅输出**执行所有【更新】和【改动】操作后的任务列表，**不包含改动说明等任何其他内容**。
2. 你也可以不执行任何操作，直接返回原计划。例如，若你认为当前的进展并没有推进研究进度，且研究计划无需改动，则可以直接返回原计划。


以下是当前计划:
{current_plan}

以下是当前的【动作历史和相应计划执行结果】（若为空则代表还没有进展，返回原计划即可）:
"""


NER_EXTRACT_TEMPLATE = """
你是一个专业的信息抽取专家，请从【用户问题】中识别出关键、核心的实体名称，并返回一个 Python 列表。


【用户问题】
{query}

【要求】:
1. 仅提取最关键的信息（通常是问题主语或命名中最核心的实体）。
2. 优先选择具有唯一标识性的名称。
3. 返回结果必须是 Python 列表格式，且形式为：["关键名称"]。
4. 使用与【用户问题】相同的语言（如中文）。
5. 不要解释、不要思考过程、不要额外文本，只输出列表。


【示例】
输入：某公司发布了产品Alpha并宣布在上海落地项目
输出：['某公司', '产品Alpha', '上海', '项目']
"""


FILTER_PROMPT_TEMPLATE = """
你是一个擅长文档关联性分析的专家，擅长判断提供的文档是否与用户问题相关。请你判断下述【文档片段】是否与【用户问题】相关：

【文档片段】
{doc_chunks}

【用户问题】
{query}

【要求】:
1. 【文档片段】中，每段文档以**Document**标志开头。
2. 所有【文档片段】都包含了【用户问题】中涉及的设备，但仅包含相关设备不能作为【文档片段】与【用户问题】相关的依据。你必须考虑该【文档片段】是否能够正面回答【用户问题】。
3. 你可以使用思考过程分析【文档片段】和【用户问题】的相关性。回答部分必须按如下格式输出两行:
第一行只输出“相关”或“无关”。
第二行只输出“SCORE: X”，其中 X 为 0 到 100 的整数，代表相关性得分。


【判断结果】:
"""


# 意图识别模板 - 用于识别是否需要快速响应
INTENT_RECOGNITION_TEMPLATE = """
# 任务
你是一个意图识别专家。请分析用户输入，判断是否属于可以快速响应的标准场景，并确定需要执行的工作流程分类。


# 用户输入
{input}

# 快速响应规则:
1. 如果用户明确只需要一句话定义/结论（如"一句话总结"、"给我结论"），返回一个简短标准答案。
2. 其他情况不触发快速响应。


# 工作流程分类识别规则:
根据用户输入的需求类型选择 workflow_categories，优先命中一条规则即可：

1. 若用户要求阅读/提取/逐段引用资料，分类为：["research-document"]
2. 若用户要求分析问题、定位原因、找漏洞/风险点，分类为：["research-problem"]
3. 若用户要求制定步骤/研究计划/路线图，分类为：["research-planning"]
4. 若用户要求做选型/权衡/给出决策建议，分类为：["research-decision"]
5. 若用户报告报错/故障/需要排查与修复建议，分类为：["technical-troubleshooting"]
6. 若用户要点子/创意/方案脑暴/设计稿，分类为：["creative-design"]
7. 其他情况，分类为：["research-general"]


# 输出格式示例:
请按照以下JSON格式输出:
```json
{{
  "is_quick_response": true/false,
  "standard_answer": "标准答案内容或空字符串",
  "workflow_categories": ["分类1", "分类2"]
}}
```


# 要求:
1. 仔细分析用户输入，匹配上述规则
2. 如果匹配任何快速响应规则，设置 is_quick_response 为 true，并提供相应的 standard_answer
3. 如果不匹配任何快速响应规则，设置 is_quick_response 为 false，standard_answer 为空字符串
4. 根据工作流程分类识别规则确定 workflow_categories 列表。
5. 必须使用JSON代码块格式输出
6. 不要添加任何解释或额外内容
"""


CONCLUSION_PROMPT_TEMPLATE = """
# 角色:
你是一名文档问答助手，你将收到一个用户问题以及一组与问题相关的上下文，请写下全面、准确的回答。


# 工作流程:
1. 根据问题筛选相关上下文，只参考与用户意图相关的内容。
2. 优先引用上下文中能够直接支撑结论的片段；不要编造信息。
3. 如果上下文包含结构化内容（如表格/列表/代码块），在不篡改内容的前提下保留关键结构。
4. 如果给定上下文没有足够信息，请明确说明信息不足，并指出缺少什么。


# 要求:
每个上下文都以一个参考数字开头，比如[x]，其中x是一个数字。回答时在对应句末引用该上下文编号。


# 用户问题:
{query}

# 问题相关上下文:
{doc_chunks}


"""
